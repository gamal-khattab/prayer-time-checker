<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>موعد الصلاة الآن؟</title>

  <!-- Luxon للتعامل مع الوقت وتوقيت السعودية -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

  <style>
    body { font-family: system-ui, Arial; margin: 20px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    select, button { padding: 10px; font-size: 16px; }
    .card { margin-top: 15px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; }
    #status { font-size: 18px; font-weight: 700; }
    .muted { color: #666; font-size: 14px; margin-top: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    td, th { border-bottom: 1px solid #eee; padding: 8px; text-align: right; }
  </style>
</head>

<body>
  <h2>هل الآن موعد صلاة؟</h2>

  <div class="row">
    <label for="city">اختر المحافظة/المدينة:</label>

    <!-- ✅ SELECT بالمناطق (كما طلبت) -->
    <select id="city">
      <optgroup label="منطقة الرياض">
        <option value="Riyadh">الرياض</option>
        <option value="Al Kharj">الخرج</option>
        <option value="Al Majmaah">المجمعة</option>
        <option value="Wadi Ad Dawasir">وادي الدواسر</option>
        <option value="Shaqra">شقراء</option>
      </optgroup>

      <optgroup label="منطقة مكة المكرمة">
        <option value="Makkah">مكة المكرمة</option>
        <option value="Jeddah">جدة</option>
        <option value="Taif">الطائف</option>
        <option value="Rabigh">رابغ</option>
        <option value="Al Lith">الليث</option>
      </optgroup>

      <optgroup label="منطقة المدينة المنورة">
        <option value="Madinah">المدينة المنورة</option>
        <option value="Yanbu">ينبع</option>
        <option value="Al Ula">العلا</option>
        <option value="Badr">بدر</option>
        <option value="Khaybar">خيبر</option>
      </optgroup>

      <optgroup label="المنطقة الشرقية">
        <option value="Dammam">الدمام</option>
        <option value="Khobar">الخبر</option>
        <option value="Dhahran">الظهران</option>
        <option value="Jubail">الجبيل</option>
        <option value="Al Ahsa">الأحساء</option>
      </optgroup>

      <optgroup label="عسير">
        <option value="Abha">أبها</option>
        <option value="Khamis Mushait">خميس مشيط</option>
        <option value="Bisha">بيشة</option>
        <option value="Mahayil">محايل عسير</option>
      </optgroup>

      <optgroup label="تبوك">
        <option value="Tabuk">تبوك</option>
        <option value="Duba">ضباء</option>
        <option value="Umluj">أملج</option>
      </optgroup>

      <optgroup label="جازان">
        <option value="Jazan">جازان</option>
        <option value="Sabya">صبيا</option>
        <option value="Abu Arish">أبو عريش</option>
      </optgroup>

      <optgroup label="نجران">
        <option value="Najran">نجران</option>
        <option value="Sharurah">شرورة</option>
      </optgroup>

      <optgroup label="حائل">
        <option value="Hail">حائل</option>
        <option value="Baqaa">بقعاء</option>
      </optgroup>

      <optgroup label="القصيم">
        <option value="Buraydah">بريدة</option>
        <option value="Unaizah">عنيزة</option>
        <option value="Ar Rass">الرس</option>
      </optgroup>

      <optgroup label="الجوف">
        <option value="Sakaka">سكاكا</option>
        <option value="Al Qurayyat">القريات</option>
      </optgroup>

      <optgroup label="الحدود الشمالية">
        <option value="Arar">عرعر</option>
        <option value="Rafha">رفحاء</option>
      </optgroup>

      <optgroup label="الباحة">
        <option value="Al Baha">الباحة</option>
        <option value="Baljurashi">بلجرشي</option>
      </optgroup>
    </select>

    <button id="checkBtn">تحقق الآن</button>
  </div>

  <div class="card">
    <div id="status">اختر مدينة واضغط “تحقق الآن”.</div>
    <div class="muted" id="meta"></div>

    <table id="timesTable" style="display:none;">
      <thead>
        <tr>
          <th>الصلاة</th>
          <th>الوقت</th>
          <th>نافذة التحقق (قبل 10 / بعد 20)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const { DateTime } = luxon;

// إعدادات السعودية
const COUNTRY = "SA";
const METHOD = 4;               // Umm Al-Qura
const TIMEZONE = "Asia/Riyadh"; // توقيت السعودية

// نافذة التحقق
const BEFORE_MIN = 10;
const AFTER_MIN  = 20;

// الصلوات اللي هنفحصها
const PRAYERS = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];

async function fetchTimings(city) {
  // ✅ نجبره يجيب مواقيت "تاريخ اليوم" بتوقيت السعودية (أفضل من الافتراضي)
  const today = DateTime.now().setZone(TIMEZONE).toFormat("yyyy-LL-dd");
  const url = `https://api.aladhan.com/v1/timingsByCity/${today}?city=${encodeURIComponent(city)}&country=${COUNTRY}&method=${METHOD}`;

  const res = await fetch(url);
  if (!res.ok) throw new Error("فشل طلب API");
  const data = await res.json();
  if (!data?.data?.timings) throw new Error("استجابة غير متوقعة من API");
  return data;
}

function parseHHMMtoDT(hhmm, baseDate) {
  // بعض القيم تأتي مثل "05:12 (AST)" أو "05:12"
  const clean = (hhmm || "").split(" ")[0].trim();
  const [h, m] = clean.split(":").map(Number);
  return baseDate.set({ hour: h, minute: m, second: 0, millisecond: 0 });
}

function formatWindow(dtStart, dtEnd) {
  return `${dtStart.toFormat("HH:mm")} → ${dtEnd.toFormat("HH:mm")}`;
}

function renderTable(baseDate, timings) {
  const table = document.getElementById("timesTable");
  const tbody = table.querySelector("tbody");
  tbody.innerHTML = "";

  PRAYERS.forEach(p => {
    const dt = parseHHMMtoDT(timings[p], baseDate);
    const wStart = dt.minus({ minutes: BEFORE_MIN });
    const wEnd   = dt.plus({ minutes: AFTER_MIN });

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p}</td>
      <td>${dt.toFormat("HH:mm")}</td>
      <td>${formatWindow(wStart, wEnd)}</td>
    `;
    tbody.appendChild(tr);
  });

  table.style.display = "";
}

function checkNow(baseDate, timings) {
  const now = DateTime.now().setZone(TIMEZONE);

  for (const p of PRAYERS) {
    const dt = parseHHMMtoDT(timings[p], baseDate);
    const start = dt.minus({ minutes: BEFORE_MIN });
    const end   = dt.plus({ minutes: AFTER_MIN });

    if (now >= start && now <= end) {
      return { inPrayerWindow: true, prayer: p, now, start, end, prayerTime: dt };
    }
  }

  return { inPrayerWindow: false, now };
}

document.getElementById("checkBtn").addEventListener("click", async () => {
  const status = document.getElementById("status");
  const meta = document.getElementById("meta");
  const city = document.getElementById("city").value;

  status.textContent = "جارٍ جلب مواقيت الصلاة وحساب الوقت...";
  meta.textContent = "";

  try {
    const apiData = await fetchTimings(city);
    const timings = apiData.data.timings;

    // تاريخ اليوم في توقيت السعودية
    const baseDate = DateTime.now().setZone(TIMEZONE).startOf("day");

    // عرض جدول المواقيت
    renderTable(baseDate, timings);

    // فحص هل الآن داخل نافذة صلاة
    const result = checkNow(baseDate, timings);

    meta.textContent = `المدينة: ${city} — الآن (السعودية): ${result.now.toFormat("yyyy-LL-dd HH:mm")}`;

    if (result.inPrayerWindow) {
      status.textContent =
        `✅ الآن موعد صلاة: ${result.prayer} (وقت الصلاة ${result.prayerTime.toFormat("HH:mm")}) — ضمن النافذة ${result.start.toFormat("HH:mm")} → ${result.end.toFormat("HH:mm")}`;
    } else {
      status.textContent = `❌ ليس موعد صلاة الآن`;
    }

  } catch (e) {
    status.textContent = "حدث خطأ أثناء جلب/حساب المواقيت.";
    meta.textContent = String(e?.message || e);
    console.error(e);
  }
});
</script>
</body>
</html>